<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Demonstration 1</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Demonstration 1</h1><br/>This was run from Bossman (Windows 10) under the context of Squid (domain user) in a non-elevated command prompt.<br /><a href=""><img src="images/1151-1.png" alt="images/1151-1.png" /></a><br />Notice that the user is just a domain user and this is all being run from a non-elevated context.<br /><a href=""><img src="images/1151-2.png" alt="images/1151-2.png" /></a><br />After AS_REP it is expected that we would have a TGT. We see here that we also completed a AP_REP and were granted the ability to access the LDAP/DC01.yee.wtf/yee.wtf SPN (this is standard).<br /><a href=""><img src="images/1151-3.png" alt="images/1151-3.png" /></a><br />These commands are simply adding a non-default namespace and then requesting a ticket for the http/IIS.yee.wtf SPN. The key point here is that you do not need to be able to authenticate with the IIS server to do this. If you send the KDC a TGS_REQ for the ‘HTTP/IIS.yee.wtf’ SPN you will recieve a TGS_REP with a Service Ticket for the desired SPN. This Service Ticket is encrypted with the password for the SPN. If you can brute force it, you&#39;ve got the password.<br /><a href=""><img src="images/1151-4.png" alt="images/1151-4.png" /></a><br />We can see that we now have a Session Ticket for the HTTP SPN.<br /><a href=""><img src="images/1151-5.png" alt="images/1151-5.png" /></a><br />Dump the Tickets to disk.<br /><a href=""><img src="images/1151-6.png" alt="images/1151-6.png" /></a><br />Move the HTTP ticket to the kali box.<br />From here all we need to is crack the hash and BOOM, we&#39;ve got a password! This brute forcing is very fast.<br /><a href=""><img src="images/1151-7.png" alt="images/1151-7.png" /></a><br />Lastly we use our HomeMadeADEnum.ps1 script to see who the owner of the SPN is.<br /><div class="codebox"><div class="codebox">####Begin&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br />$DomainObj&nbsp;=&nbsp;[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()<br />$PDC&nbsp;=&nbsp;($DomainObj.PdcRoleOwner).Name<br />$SearchString&nbsp;=&nbsp;&quot;LDAP://&quot;<br />$SearchString&nbsp;+=&nbsp;$PDC&nbsp;+&nbsp;&quot;/&quot;<br />$DistinguishedName&nbsp;=&nbsp;&quot;DC=$($DomainObj.Name.Replace(&#39;.&#39;,&nbsp;&#39;,DC=&#39;))&quot;<br />$SearchString&nbsp;+=&nbsp;$DistinguishedName<br />$SearchString<br />####Finish&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br /><br />####Begin&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br />$Searcher&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)&nbsp;<br />$objDomain&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectoryEntry&nbsp;<br />$Searcher.SearchRoot&nbsp;=&nbsp;$objDomain<br />####Finish&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br /><br />####Begin&nbsp;Create&nbsp;Filter<br />$Searcher.filter=&quot;serviceprincipalname=*&quot;<br />$Result&nbsp;=&nbsp;$Searcher.FindAll()<br />foreach&nbsp;($obj&nbsp;in&nbsp;$Result){<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($obj.Properties.serviceprincipalname&nbsp;-like&nbsp;&#39;*http/iis*&#39;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($value&nbsp;in&nbsp;$obj.Properties){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value}}}<br /><br /><br /><br /></div></div><br /><a href=""><img src="images/1151-8.png" alt="images/1151-8.png" /></a><br />Now we know the owner of the HTTP SPN is Tripp, his password is &quot;Passw0rd,&quot; and he is a member of the IIS_IUSRS group.<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></div></body></html>