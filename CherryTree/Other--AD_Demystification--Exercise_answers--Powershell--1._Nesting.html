<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>1. Nesting</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>1. Nesting</h1><br/><div class="codebox"><div class="codebox">####Begin&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br />$DomainObj&nbsp;=&nbsp;[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()<br />$PDC&nbsp;=&nbsp;($DomainObj.PdcRoleOwner).Name<br />$SearchString&nbsp;=&nbsp;&quot;LDAP://&quot;<br />$SearchString&nbsp;+=&nbsp;$PDC&nbsp;+&nbsp;&quot;/&quot;<br />$DistinguishedName&nbsp;=&nbsp;&quot;DC=$($DomainObj.Name.Replace(&#39;.&#39;,&nbsp;&#39;,DC=&#39;))&quot;<br />$SearchString&nbsp;+=&nbsp;$DistinguishedName<br />$SearchString<br />####Finish&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br /><br />####Begin&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br />$Searcher&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)&nbsp;<br />$objDomain&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectoryEntry&nbsp;<br />$Searcher.SearchRoot&nbsp;=&nbsp;$objDomain<br />####Finish&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br /><br />####Begin&nbsp;Create&nbsp;Filter<br />$Searcher.filter=&quot;(ObjectClass=*)&quot;<br />$Result&nbsp;=&nbsp;$Searcher.FindAll()<br />foreach&nbsp;($obj&nbsp;in&nbsp;$Result){<br />&nbsp;&nbsp;&nbsp;if&nbsp;($obj.properties.name&nbsp;-like&nbsp;&#39;*marforcyber*&#39;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$root&nbsp;=&nbsp;$obj<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$grouplist&nbsp;=&nbsp;@(&#39;root&nbsp;&#39;+$root.properties.name)}}<br />$memberofcount&nbsp;=&nbsp;1<br />while&nbsp;($memberofcount&nbsp;-ge&nbsp;1){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($obj&nbsp;in&nbsp;$Result){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($obj.properties.memberof&nbsp;-like&nbsp;$root.properties.distinguishedname){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($obj.Properties.samaccounttype&nbsp;-like&nbsp;&#39;*268435456*&#39;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$grouplist&nbsp;+=&nbsp;&#39;nested&nbsp;group&nbsp;of&nbsp;&#39;+&nbsp;$obj.Properties.memberof&nbsp;+&nbsp;&#39;&nbsp;=&nbsp;&#39;&nbsp;+&nbsp;$obj.Properties.name}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{$grouplist&nbsp;+=&nbsp;&#39;nested&nbsp;user&nbsp;of&nbsp;&#39;+&nbsp;$obj.Properties.memberof&nbsp;+&nbsp;&#39;&nbsp;=&nbsp;&#39;&nbsp;+&nbsp;$obj.Properties.name}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memberofcount&nbsp;=&nbsp;$obj.Properties.member.Count<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$root&nbsp;=&nbsp;$obj<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break}}}<br />$grouplist<br /></div></div><br /><a href=""><img src="images/1198-1.png" alt="images/1198-1.png" /></a><br />...or a better way done with the active directory module  (the script can be found on DC01).<br /><a href=""><img src="images/1198-2.png" alt="images/1198-2.png" /></a><br /><a href="https://gallery.technet.microsoft.com/scriptcenter/Get-nested-group-15f725f2">https://gallery.technet.microsoft.com/scriptcenter/Get-nested-group-15f725f2</a><br /><br /><div class="codebox"><div class="codebox">####Begin&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br />$DomainObj&nbsp;=&nbsp;[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()<br />$PDC&nbsp;=&nbsp;($DomainObj.PdcRoleOwner).Name<br />$SearchString&nbsp;=&nbsp;&quot;LDAP://&quot;<br />$SearchString&nbsp;+=&nbsp;$PDC&nbsp;+&nbsp;&quot;/&quot;<br />$DistinguishedName&nbsp;=&nbsp;&quot;DC=$($DomainObj.Name.Replace(&#39;.&#39;,&nbsp;&#39;,DC=&#39;))&quot;<br />$SearchString&nbsp;+=&nbsp;$DistinguishedName<br />$SearchString<br />####Finish&nbsp;Create&nbsp;Ldap&nbsp;Provider&nbsp;Path<br /><br />####Begin&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br />$Searcher&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)&nbsp;<br />$objDomain&nbsp;=&nbsp;New-Object&nbsp;System.DirectoryServices.DirectoryEntry&nbsp;<br />$Searcher.SearchRoot&nbsp;=&nbsp;$objDomain<br />####Finish&nbsp;Create&nbsp;Directory&nbsp;Searcher&nbsp;Object<br /><br />####Begin&nbsp;Create&nbsp;Filter<br />$Searcher.filter=&quot;(ObjectClass=user)&quot;<br />$Result&nbsp;=&nbsp;$Searcher.FindAll()<br />foreach&nbsp;($obj&nbsp;in&nbsp;$Result){<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($obj.Properties.userprincipalname&nbsp;-like&nbsp;&#39;*kvothe*&#39;){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$obj.Properties.manager<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br /></div></div><br /><a href=""><img src="images/1198-3.png" alt="images/1198-3.png" /></a></div></body></html>